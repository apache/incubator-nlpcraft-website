---
active_crumb: Weather Bot <code><sub>ex</sub></code>
layout: documentation
id: weather_bot
---

<!--
 Licensed to the Apache Software Foundation (ASF) under one or more
 contributor license agreements.  See the NOTICE file distributed with
 this work for additional information regarding copyright ownership.
 The ASF licenses this file to You under the Apache License, Version 2.0
 (the "License"); you may not use this file except in compliance with
 the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<div class="col-md-8 second-column">
    <section id="overview">
        <h2 class="section-title">Overview</h2>
        <p>
            This example demonstrates relatively complete NLI-based weather service with JSON output and a non-trivial
            intent matching logic. It uses Apple's <a target="new" href="https://darksky.net">DarkSky</a>
            REST service for the actual weather information.
        </p>
        <p>
            Complexity: <span class="complexity-two-star"><i class="fas fa-square"></i> <i class="fas fa-square"></i> <i class="far fa-square"></i></span><br/>
            Source code: <a target="github" href="https://github.com/apache/incubator-nlpcraft/tree/master/nlpcraft/src/main/scala/org/apache/nlpcraft/examples/weather">GitHub</a>
        </p>
    </section>
    <section id="new_project">
        <h3 class="section-title">Create New Project</h3>
        <p>
            You can create new Java project in many different ways - we'll use Maven archetype generation
            for that. In your home folder run the following command:
        </p>
        <pre class="brush: text">
            mvn archetype:generate -DgroupId=examples -DartifactId=my-app -DarchetypeVersion=1.4 -DinteractiveMode=false
        </pre>
        <p>
            This will create <code>my-app</code> folder with the following default maven project structure:
        </p>
        <pre class="console">
├── <b>pom.xml</b>
└── src
    ├── main
    │   └── java
    │       └── examples
    │           └── App.java
    └── test
        └── java
            └── examples
                └── AppTest.java
        </pre>
        <div class="bq info">
            <p>
                Note that this setup is same for all examples. Note also that you can use any other tools for
                creating and managing Java project with or without Maven.
            </p>
        </div>
        <p>
            For our example we'll use JetBrain's <a target=_new href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a>.
            Create new IDEA project from this source folder (make sure to pick JDK 8 or later JDK and language support).
            Let's also delete auto-generated files <code>App.java</code> and <code>AppTest.java</code> from our
            project as we won't be using them.
        </p>
    </section>
    <section id="add_nlpcraft">
        <h3 class="section-title">Add NLPCraft</h3>
        <p>
            Next we need to add NLPCraft dependency to our new project. Open <code>pom.xml</code> file and replace
            <code>dependencies</code> section with the following code:
        </p>
        <pre class="brush: xml, highlight: [3, 4, 5]">
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.apache.nlpcraft&lt;/groupId&gt;
                    &lt;artifactId&gt;nlpcraft&lt;/artifactId&gt;
                    &lt;version&gt;{{site.latest_version}}&lt;/version&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        </pre>
        <p>
            Also make sure that you have correct JDK version (1.8 or above) for the maven compiler plugin:
        </p>
        <pre class="brush: xml, highlight: [3, 4]">
            &lt;properties&gt;
                &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
                &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
                &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
            &lt;/properties&gt;
        </pre>
        <p>
            IDEA should automatically reload the project with newly updated <code>pom.xml</code> file and
            we should be ready now to develop our data model.
        </p>
    </section>
    <section id="model">
        <h3 class="section-title">Data Model</h3>
        <p>
            We are going to start with declaring the static part of our semantic model using JSON which we will later load using
            <code>NCModelFileAdapter</code> in our Java-based model implementation. Create new <code>weather_model.json</code>
            file and add the following model declaration into it:
        </p>
        <pre class="brush: js, highlight: [10, 18, 28]">
{
  "id": "nlpcraft.weather.ex",
  "name": "Weather Example Model",
  "version": "1.0",
  "description": "Weather example model.",
  "macros": [
  ],
  "elements": [
    {
      "id": "wt:phen",
      "description": "Weather phenomenon.",
      "synonyms": [
        "{high sea|severe weather|hail|heat wave|cold wave|derecho|supercell|avalanche|cyclone|wildfire|landslide|firestorm|dust storm|thunder snow|winter storm|cloudburst|shower|condensation|precipitation|drizzle|rainstorm|rain storm|rainfall|rain|storm|sun|sunshine|cloud|hot|cold|dry|wet|wind||hurricane|typhoon|sand-storm|sand storm|tornado|humid|fog|snow|smog|black ice|haze|thundershower|thundersnow|sleet|drought|wildfire|blizzard|avalanche|mist|thunderstorm}",
        "{weather {condition|temp|temperature|data|*}|condition|temp|temperature}"
      ]
    },
    {
      "id": "wt:hist",
      "description": "History (past) indicator.",
      "groups": [
        "indicator"
      ],
      "synonyms": [
        "{history|past|previous}"
      ]
    },
    {
      "id": "wt:fcast",
      "description": "Forecast (future) indicator.",
      "groups": [
        "indicator"
      ],
      "synonyms": [
        "{future|forecast|prognosis|prediction}"
      ]
    }
  ]
}
        </pre>
        <p>There are number of important points here:</p>
        <ul>
            <li>
                <code>Line 10</code> defines an element <code>wt:phen</code> for various weather phenomenon.
            </li>
            <li>
                <code>Line 18</code> defines an element <code>wt:hist</code> which presence will indicate the
                request for the past (history) weather information.
            </li>
            <li>
                <code>Line 28</code> defines an element <code>wt:fcast</code> which presence will indicate the
                request for the future (forecast) weather information.
            </li>
        </ul>
        <p>
            Now that our model is ready let's create a Java class that would load this model and define intents
            that use the model elements we have just defined.
        </p>
    </section>
    <section id="code">
        <h3 class="section-title">Model Class</h3>
        <p>
            Our Java implementation uses one auxiliary class <a target="github" href="https://github.com/apache/incubator-nlpcraft/blob/master/src/main/scala/org/apache/nlpcraft/examples/weather/WeatherResultWrapper.java">WeatherResultWrapper.java</a>
            that is used for JSON result formatting. Note that the main <a target="github" href="https://github.com/apache/incubator-nlpcraft/blob/master/src/main/scala/org/apache/nlpcraft/examples/weather/WeatherModel.java">WeatherModel</a> class
            have number of utility methods that we'll skip here (you can see the entire class by following the link above) and
            we'll concentrate on the intents only:
        </p>
        <pre class="brush: java, highlight: []">
package org.apache.nlpcraft.examples.weather;

import com.google.gson.Gson;
import org.apache.commons.lang3.tuple.Pair;
import org.apache.nlpcraft.examples.misc.darksky.DarkSkyException;
import org.apache.nlpcraft.examples.misc.darksky.DarkSkyService;
import org.apache.nlpcraft.examples.misc.geo.keycdn.GeoManager;
import org.apache.nlpcraft.examples.misc.geo.keycdn.beans.GeoDataBean;
import org.apache.nlpcraft.model.*;
import java.time.Instant;
import java.util.*;
import static java.time.temporal.ChronoUnit.DAYS;

public class WeatherModel extends NCModelFileAdapter {
    // Please register your own account at https://darksky.net/dev/docs/libraries and
    // replace this demo token with your own.
    private final DarkSkyService darkSky = new DarkSkyService("097e1aad75b22b88f494cf49211975aa", 31);

    private final GeoManager geoMrg = new GeoManager();
    private static final int DAYS_SHIFT = 5;
    private static final Gson GSON = new Gson();
    private static final Set&lt;String&gt; LOCAL_WORDS = new HashSet&lt;&gt;(Arrays.asList("my", "local", "hometown"));

    private Pair&lt;Double, Double&gt; prepGeo(NCIntentMatch ctx, Optional&lt;NCToken&gt; geoTokOpt) throws NCRejection {
        if (geoTokOpt.isPresent()) {
            NCToken geoTok = geoTokOpt.get();

            Map&lt;String, Object&gt; cityMeta = geoTok.meta("nlpcraft:city:citymeta");

            Double lat = (Double)cityMeta.get("latitude");
            Double lon = (Double)cityMeta.get("longitude");

            if (lat == null || lon == null) {
                String city = geoTok.meta("nlpcraft:city:city");

                throw new NCRejection(String.format("Latitude and longitude not found for: %s", city));
            }

            return Pair.of(lat, lon);
        }

        Optional&lt;GeoDataBean&gt; geoOpt = geoMrg.get(ctx.getContext().getRequest());

        if (!geoOpt.isPresent())
            throw new NCRejection("City cannot be determined.");

        // Manually process request for local weather. We need to separate between 'local Moscow weather'
        // and 'local weather' which are different. Basically, if there is word 'local/my/hometown' in the user
        // input and there is no city in the current sentence - this is a request for the weather at user's
        // current location, i.e. we should implicitly assume user's location and clear conversion context.
        // In all other cases - we take location from either current sentence or conversation STM.

        // NOTE: we don't do this separation on intent level as it is easier to do it here instead of
        // creating more intents with almost identical callbacks.

        @SuppressWarnings("SuspiciousMethodCalls")
        boolean hasLocalWord =
            ctx.getVariant().stream().anyMatch(t -&gt; LOCAL_WORDS.contains(t.meta("nlpcraft:nlp:origtext")));

        if (hasLocalWord)
            // Because we implicitly assume user's current city at this point we need to clear
            // 'nlpcraft:city' tokens from conversation since they would no longer be valid.
            ctx.getContext().getConversation().clearStm(t -&gt; t.getId().equals("nlpcraft:city"));

        // Try current user location.
        GeoDataBean geo = geoOpt.get();

        return Pair.of(geo.getLatitude(), geo.getLongitude());
    }
                    
    @NCIntent(
        "intent=req " +
        "conv=true " + // Support conversation context (i.e. short term memory).
        "term={id == 'wt:phen'}+ " + // One or more weather phenomenon (at least is mandatory).
        "term(ind)={groups @@ 'indicator'}* " + // Optional indicator words (zero or more).
        "term(city)={id == 'nlpcraft:city'}? " + // Optional city.
        "term(date)={id == 'nlpcraft:date'}?" // Optional date (overrides indicator words).
    )
    @NCIntentSample({
        "What's the local weather forecast?",
        "What's the weather in Moscow?",
        "What is the weather like outside?",
        "How's the weather?",
        "What's the weather forecast for the rest of the week?",
        "What's the weather forecast this week?",
        "What's the weather out there?",
        "Is it cold outside?",
        "Is it hot outside?",
        "Will it rain today?",
        "When it will rain in Delhi?",
        "Is there any possibility of rain in Delhi?",
        "Is it raining now?",
        "Is there any chance of rain today?",
        "Was it raining in Beirut last week?",
        "How about yesterday?"
    })
    public NCResult onMatch(
        NCIntentMatch ctx,
        @NCIntentTerm("ind") List&lt;NCToken&gt; indToksOpt,
        @NCIntentTerm("city") Optional&lt;NCToken&gt; cityTokOpt,
        @NCIntentTerm("date") Optional&lt;NCToken&gt; dateTokOpt
    ) {
        // Reject if intent match is not exact (at least one "dangling" token remain).
        if (ctx.isAmbiguous())
            throw new NCRejection("Please clarify your request.");

        try {
            Instant now = Instant.now();

            Instant from = now;
            Instant to = now;

            if (indToksOpt.stream().anyMatch(tok -&gt; tok.getId().equals("wt:hist")))
                from = from.minus(DAYS_SHIFT, DAYS);
            else if (indToksOpt.stream().anyMatch(tok -&gt; tok.getId().equals("wt:fcast")))
                to = from.plus(DAYS_SHIFT, DAYS);

            if (dateTokOpt.isPresent()) { // Date token overrides any indicators.
                NCToken dateTok = dateTokOpt.get();

                from = Instant.ofEpochMilli(dateTok.meta("nlpcraft:date:from"));
                to = Instant.ofEpochMilli(dateTok.meta("nlpcraft:date:to"));
            }

            Pair&lt;Double, Double&gt; latLon = prepGeo(ctx, cityTokOpt); // Handles optional city too.

            double lat = latLon.getLeft();
            double lon = latLon.getRight();

            return NCResult.json(GSON.toJson(from == to ? darkSky.getCurrent(lat, lon) :
                darkSky.getTimeMachine(lat, lon, from, to)));
        }
        catch (DarkSkyException e) {
            throw new NCRejection(e.getLocalizedMessage());
        }
        catch (NCRejection e) {
            throw e;
        }
        catch (Exception e) {
            throw new NCRejection("Weather provider error.", e);
        }
    }
                                
    public WeatherModel() {
        // Load model from external JSON file on classpath.
        super("org/apache/nlpcraft/examples/weather/weather_model.json");
    }

    @Override
    public void onDiscard() {
        darkSky.stop();
    }
}
        </pre>
        <p>
            There three methods define three intents. Each intent is defined "in place", i.e. as an annotation on the
            method that acts as a callback for that intent:
        </p>
        <ul>
            <li>
                Line 1 defines intent and the callback for the weather forecast (weather in the future):
                <ul>
                    <li>Intent is ordered (default), supports conversation (default) and has ID <code>fcast</code></li>
                    <li>Intent has one mandatory term and two optional terms:
                        <ul>
                            <li>
                                Mandatory term is defined as a token with ID <code>wt:fcast</code> as defined
                                in the model.
                            </li>
                            <li>
                                Two optional terms (their IDs are <code>city</code> and <code>date</code>) define
                                optional city and date for the weather report. If not provided, their will be taken
                                from either conversation context or assume the default value (current IP geo location
                                and current time, if available).
                            </li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li>
                Lines 3-5 define formal parameters for the <code>fcast</code> intent callback method. Note that we use term IDs
                (<code>city</code> and <code>date</code>) in <code>@NCIntentTerm</code> annotations to automatically
                assign tokens from the detected terms to their corresponding method formal parameters.
            </li>
            <li>
                Lines 10-14 and lines 19-23 define two other intents and their callbacks methods in the same manner.
            </li>
            <li>
                Implementation of all intent callback method is pretty straightforward and deals mostly with figuring
                out the default location and time if either one isn't provided.
            </li>
        </ul>
    </section>
    <section id="tools">
        <h3 class="section-title">External Tools</h3>
        <p>
            This example uses several external tools to implement its functionality:
        </p>
        <ul>
            <li>
                <a target=_ href="https://darksky.net">Apple DarkSky</a> - to provide actual weather data service
                See <code>org.apache.nlpcraft.examples.misc.darksky</code> package for details.
            </li>
            <li>
                <a target="_" href="https://tools.keycdn.com/geo">KeyCDN's IP Location Finder</a> - to provide IP location
                service. See <code>org.apache.nlpcraft.examples.misc.geo.keycdn</code> package for details.
            </li>
            <li>
                City to timezone mapper. See <code>org.apache.nlpcraft.examples.misc.geo.cities</code> package for details.
            </li>
        </ul>
    </section>
    <section id="start_probe">
        <h3 class="section-title">Start Data Probe <sub>optional</sub></h3>
        <div class="bq warn">
            <p><b>Embedded Probe</b></p>
            <p>
                If you are using the <a href="#testing">unit test</a> that comes with this example you <b>do not</b>
                need to start the data probe standalone as this unit test uses embedded probe mode. In this mode, the unit
                test will automatically start and stop the data probe from within the test itself.
            </p>
            <p>
                <b>If using <a href="#testing">unit test</a> below - skip this step, you only need to start the server.</b>
            </p>
        </div>
        <p>
            NLPCraft data models get deployed into data probe. Let's start a standalone data probe with our newly
            created data model. To start data probe we need to configure Run Configuration in IDEA with
            the following parameters:
        </p>
        <ul>
            <li>
                <b>Main class:</b> <code>org.apache.nlpcraft.NCStart</code>
            </li>
            <li>
                <b>VM arguments:</b> <code>-Dconfig.override_with_env_vars=true</code>
            </li>
            <li>
                <b>Environment variable:</b> <code>CONFIG_FORCE_nlpcraft_probe_models.0=org.apache.nlpcraft.examples.weather.WeatherModel</code>
            </li>
            <li>
                <b>Program arguments: </b> <code>-probe</code>
            </li>
        </ul>
        <div class="bq info">
            <p>
                <b>NOTE:</b> instead of supplying a <a href="/server-and-probe.html">full configuration file</a> we just
                use the default configuration and override one configuration property using
                configuration override via environment variables.
            </p>
        </div>
        <p>
            Start this run configuration and make sure you have positive console output indicating that our model
            has been successfully loaded and probe started.
        </p>
    </section>
    <section id="start_server">
        <h3 class="section-title">Start REST Server</h3>
        <p>
            REST server listens for requests from client applications and routes them to the requested data models
            via connected data probes. REST server starts the same way as the data probe. Configure new
            Run Configuration in IDEA with the following parameters:
        </p>
        <ul>
            <li>
                <b>Main class:</b> <code>org.apache.nlpcraft.NCStart</code>
            </li>
            <li>
                <b>Program arguments: </b> <code>-server</code>
            </li>
        </ul>
        <p>
            Once started ensure that your REST server console output shows that data probe is connected and the
            REST server is listening on the default <code>localhost:8081</code> endpoint.
        </p>
        <p>
            At this point we've developed our data model, deployed it into the data probe, and started the REST server.
            To test it, we'll use the built-in <a href="/tools/test_framework.html">test framework</a>
            that allows you to write convenient unit tests against your data model.
        </p>
    </section>
    <section id="testing">
        <h3 class="section-title">Testing</h3>
        <p>
            NLPCraft comes with easy to use <a href="/tools/test_framework.html">test framework</a> for
            data models that can be used with
            any unit testing framework like JUnit or ScalaTest. It is essentially a simplified
            version of Java REST client that is custom designed for data model testing.
        </p>
        <p>
            We would like to test with following user requests:
        </p>
        <ul>
            <li><code>"What's the local weather forecast?"</code></li>
            <li><code>"What's the weather in Moscow?"</code></li>
            <li><code>"Chance of snow?"</code> (using conversation context)</li>
            <li><code>"Moscow?"</code> (using conversation context).</li>
        </ul>
        <p>
            Let's create new Java class <code>WeatherTest.java</code> with the following code:
        </p>
        <pre class="brush: java, highlight: [47, 43, 55, 59]">
package org.apache.nlpcraft.examples.weather;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import org.apache.nlpcraft.common.NCException;
import org.apache.nlpcraft.model.tools.test.NCTestClient;
import org.apache.nlpcraft.model.tools.test.NCTestClientBuilder;
import org.apache.nlpcraft.model.tools.test.NCTestResult;
import org.apache.nlpcraft.probe.embedded.NCEmbeddedProbe;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.lang.reflect.Type;
import java.util.HashMap;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

class WeatherTest {
    private static final Gson GSON = new Gson();
    private static final Type TYPE_MAP_RESP = new TypeToken&lt;HashMap&lt;String, Object&gt;&gt;() {}.getType();
    private NCTestClient cli;
            
    private void checkIntent(String txt, String intentId, boolean shouldBeSame) throws NCException, IOException {
        NCTestResult res = cli.ask(txt);

        assertTrue(res.isOk(), () -&gt; res.getResultError().get());

        assert res.getResult().isPresent();

        Map&lt;String, Object&gt; map = GSON.fromJson(res.getResult().get(), TYPE_MAP_RESP);

        if (shouldBeSame)
            assertEquals(intentId, map.get("intentId"));
        else
            assertNotEquals(intentId, map.get("intentId"));
    }

    @BeforeEach
    void setUp() throws NCException, IOException {
        NCEmbeddedProbe.start(WeatherModel.class);

        cli = new NCTestClientBuilder().newBuilder().build();

        cli.open("nlpcraft.weather.ex");  // See weather_model.json
    }

    @AfterEach
    void tearDown() throws NCException, IOException {
        if (cli != null)
            cli.close();

        NCEmbeddedProbe.stop();
    }

    @Test
    void test() throws NCException, IOException {
        // Empty parameter.
        assertTrue(cli.ask("").isFailed());

        // Only latin charset is supported.
        assertTrue(cli.ask("El tiempo en España").isFailed());

        // Should be passed.
        checkIntent("What's the local weather forecast?", "fcast", true);
        checkIntent("What's the weather in Moscow?", "curr", true);
        // Can be answered with conversation.
        checkIntent("Chance of snow?", "curr", true);
        checkIntent("Moscow", "curr", true);

        cli.clearConversation();

        // Cannot be answered without conversation.
        assertTrue(cli.ask("Moscow").isFailed());
    }
}
        </pre>
        <p>
            This test is pretty straight forward:
        </p>
        <ul>
            <li>
                On line 47 we open the test client with the model ID (see <code>weather_model.yaml</code>
                file for where we declared it).
            </li>
            <li>
                Test on line 59 is where we issue our test sentences and we should see
                the confirmation messages in our test console output.
            </li>
        </ul>
        <div class="bq info">
            <p><b>Embedded Probe</b></p>
            <p>
                This test uses <a href="/tools/embedded_probe.html">embedded probe</a> which automatically
                starts and stops the data probe from within the tests itself. See lines 43 and 55 for details.
            </p>
            <p>
                <b>NOTE:</b> when using this test you don't need to start data probe standalone in a previous step.
            </p>
        </div>
        <p>
            Right click on this class in the project view and run it. You should be getting standard output in
            JUnit panel as well as the output in the data probe console.
        </p>
    </section>
    <section>
        <h2 class="section-title">Done! 👌</h2>
        <p>
            You've created pretty full featured weather bot data model, deployed it into the data probe, started the
            REST server and tested this model using JUnit 5 and the built-in test framework.
        </p>
    </section>
</div>
<div class="col-md-2 third-column">
    <ul class="side-nav">
        <li class="side-nav-title">On This Page</li>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#new_project">New Project</a></li>
        <li><a href="#add_nlpcraft">Add NLPCraft</a></li>
        <li><a href="#model">Data Model</a></li>
        <li><a href="#code">Model Class</a></li>
        <li><a href="#tools">External Tools</a></li>
        <li><a href="#start_probe">Start Probe <sub>opt</sub></a></li>
        <li><a href="#start_server">Start Server</a></li>
        <li><a href="#testing">Testing</a></li>
        {% include quick-links.html %}
    </ul>
</div>






